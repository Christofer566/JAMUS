name: Critical Files Guard

on:
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Validate package.json
        run: |
          echo "ğŸ” Checking critical dependencies..."
          
          # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì²´í¬
          REQUIRED_PACKAGES=("next" "react" "react-dom" "@supabase/supabase-js")
          
          for package in "${REQUIRED_PACKAGES[@]}"; do
            if ! grep -q "\"$package\"" package.json; then
              echo "âŒ CRITICAL: $package is missing!"
              echo "ğŸš¨ EMERGENCY SHUTDOWN TRIGGERED"
              
              # Slack ê¸´ê¸‰ ì•Œë¦¼
              curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
                -H 'Content-Type: application/json' \
                -d "{\"text\":\"ğŸš¨ EMERGENCY: $package removed from package.json! System halted.\"}"
              
              exit 1
            fi
          done
          
          echo "âœ… All critical dependencies present"
      
      - name: Count total dependencies
        run: |
          DEPS_COUNT=$(cat package.json | jq '.dependencies | length')
          echo "ğŸ“¦ Total dependencies: $DEPS_COUNT"
          
          # ì˜ì¡´ì„±ì´ 10ê°œ ë¯¸ë§Œì´ë©´ ë­”ê°€ ì˜ëª»ë¨
          if [ "$DEPS_COUNT" -lt 10 ]; then
            echo "âŒ CRITICAL: Too few dependencies ($DEPS_COUNT)"
            echo "Expected: 20+ dependencies"
            exit 1
          fi