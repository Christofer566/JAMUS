name: Deploy and Notify

on:
  deployment_status:
  workflow_dispatch:

jobs:
  notify-deployment:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract Task and Week Number
        id: task
        run: |
          # Extract task and week number from commit message (first line only)
          # Format: [WXX] Task X.Y: type - description
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Debug: Commit message is '$COMMIT_MSG'"

          # Week Î≤àÌò∏ Ï∂îÏ∂ú (Ïòà: [W05] -> W05, Ïã§Ìå® Ïãú "none")
          WEEK_NUM=$(echo "$COMMIT_MSG" | grep -oP '\[W\d+\]' | head -1 | tr -d '[]')
          if [ -z "$WEEK_NUM" ]; then
            WEEK_NUM="none"
          fi
          echo "Debug: Extracted WEEK_NUM is '$WEEK_NUM'"

          # Task Î≤àÌò∏ Ï∂îÏ∂ú (Ïã§Ìå® Ïãú "none" Î∞òÌôò, "0"ÎèÑ Ïú†Ìö®Ìïú Task)
          TASK_NUM=$(echo "$COMMIT_MSG" | grep -o 'Task [0-9.]\+' | head -1 | sed 's/Task //')
          if [ -z "$TASK_NUM" ]; then
            TASK_NUM="none"
          fi
          echo "Debug: Extracted TASK_NUM is '$TASK_NUM'"
          {
            echo "week_number=$WEEK_NUM"
            echo "task_number=$TASK_NUM"
            echo "commit_message<<EOF"
            echo "$COMMIT_MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Get Commit Info
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_TIME=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "time=$COMMIT_TIME" >> $GITHUB_OUTPUT

      - name: Clean Old Task Logs from Context Hub
        id: clean_logs
        continue-on-error: true
        if: steps.task.outputs.task_number != 'none'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          CONTEXT_HUB_PAGE_ID: ${{ secrets.CONTEXT_HUB_PAGE_ID }}
          TASK_NUMBER: ${{ steps.task.outputs.task_number }}
        run: |
          echo "üîç Checking existing logs in Context Hub..."

          # ÌòÑÏû¨ TaskÏùò Ï†ïÏàò Î∂ÄÎ∂Ñ Ï∂îÏ∂ú (0.1 -> 0, 1.2 -> 1)
          CURRENT_TASK_INT=$(echo "$TASK_NUMBER" | cut -d'.' -f1)
          echo "Current Task (integer part): $CURRENT_TASK_INT"

          # ÌéòÏù¥ÏßÄ Î∏îÎ°ùÎì§ Ï°∞Ìöå
          BLOCKS_RESPONSE=$(curl -s -X GET "https://api.notion.com/v1/blocks/${CONTEXT_HUB_PAGE_ID}/children?page_size=100" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Notion-Version: 2022-06-28")

          # Î°úÍ∑∏ Î∏îÎ°ù ÌïÑÌÑ∞ÎßÅ Î∞è ÏÇ≠Ï†ú
          DELETED_COUNT=0
          BLOCK_IDS=$(echo "$BLOCKS_RESPONSE" | jq -r '.results[] | select(.type == "paragraph") | select(.paragraph.rich_text[0].text.content | startswith("‚úÖ [")) | .id')

          for BLOCK_ID in $BLOCK_IDS; do
            # Ìï¥Îãπ Î∏îÎ°ùÏùò ÌÖçÏä§Ìä∏ÏóêÏÑú Task Î≤àÌò∏ Ï∂îÏ∂ú
            BLOCK_TEXT=$(echo "$BLOCKS_RESPONSE" | jq -r --arg id "$BLOCK_ID" '.results[] | select(.id == $id) | .paragraph.rich_text[0].text.content')
            BLOCK_TASK=$(echo "$BLOCK_TEXT" | grep -oP 'Task \K[0-9]+' | head -1)

            echo "Found log block: Task $BLOCK_TASK (Block ID: $BLOCK_ID)"

            # Task Î≤àÌò∏Í∞Ä Îã§Î•¥Î©¥ ÏÇ≠Ï†ú
            if [ -n "$BLOCK_TASK" ] && [ "$BLOCK_TASK" != "$CURRENT_TASK_INT" ]; then
              echo "üóëÔ∏è Deleting old Task $BLOCK_TASK log..."
              DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE "https://api.notion.com/v1/blocks/${BLOCK_ID}" \
                -H "Authorization: Bearer ${NOTION_API_KEY}" \
                -H "Notion-Version: 2022-06-28")

              DELETE_CODE=$(echo "$DELETE_RESPONSE" | tail -n1)
              if [ "$DELETE_CODE" = "200" ]; then
                DELETED_COUNT=$((DELETED_COUNT + 1))
                echo "‚úÖ Deleted successfully"
              else
                echo "‚ö†Ô∏è Failed to delete (HTTP $DELETE_CODE)"
              fi

              # Rate limit Î∞©ÏßÄ
              sleep 0.3
            fi
          done

          echo "üßπ Cleaned up $DELETED_COUNT old log(s)"
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT

      - name: Update Notion Context Hub
        id: notion
        continue-on-error: true
        if: steps.task.outputs.task_number != 'none'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          CONTEXT_HUB_PAGE_ID: ${{ secrets.CONTEXT_HUB_PAGE_ID }}
          TASK_NUMBER: ${{ steps.task.outputs.task_number }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
          COMMIT_TIME: ${{ steps.commit.outputs.time }}
          COMMIT_MESSAGE: ${{ steps.task.outputs.commit_message }}
        run: |
          echo "üìù Updating Notion Context Hub..."

          # ÏôÑÎ£å Î°úÍ∑∏ Î©îÏãúÏßÄ ÏÉùÏÑ±
          LOG_MESSAGE="‚úÖ [${COMMIT_TIME}] Task ${TASK_NUMBER} ÏôÑÎ£å - ${COMMIT_MESSAGE} (${COMMIT_SHA})"
          echo "Log message: $LOG_MESSAGE"

          # Notion API Ìò∏Ï∂ú - Context Hub ÌéòÏù¥ÏßÄ ÌïòÎã®Ïóê Î°úÍ∑∏ Ï∂îÍ∞Ä
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "https://api.notion.com/v1/blocks/${CONTEXT_HUB_PAGE_ID}/children" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "children": [
                {
                  "object": "block",
                  "type": "paragraph",
                  "paragraph": {
                    "rich_text": [
                      {
                        "type": "text",
                        "text": {
                          "content": "'"${LOG_MESSAGE}"'"
                        }
                      }
                    ]
                  }
                }
              ]
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Context Hub ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ!"
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Context Hub ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå® (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Phase Status in Context Hub
        id: phase_update
        continue-on-error: true
        if: steps.task.outputs.task_number != 'none'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          CONTEXT_HUB_PAGE_ID: ${{ secrets.CONTEXT_HUB_PAGE_ID }}
          COMMIT_MESSAGE: ${{ steps.task.outputs.commit_message }}
        run: |
          echo "üîç Checking for Phase number in commit message..."

          # Phase Î≤àÌò∏ Ï∂îÏ∂ú (Task X.YÏóêÏÑú Y Ï∂îÏ∂ú)
          PHASE_NUM=$(echo "$COMMIT_MESSAGE" | grep -oP 'Task \d+\.(\d+):' | grep -oP '\.\d+' | tr -d '.')

          if [ -z "$PHASE_NUM" ]; then
            echo "‚ÑπÔ∏è No Phase number found, skipping Phase update"
            echo "phase_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìå Found Phase $PHASE_NUM, updating Context Hub..."

          # ÌéòÏù¥ÏßÄ Î∏îÎ°ùÎì§ Ï°∞Ìöå
          BLOCKS_RESPONSE=$(curl -s -X GET "https://api.notion.com/v1/blocks/${CONTEXT_HUB_PAGE_ID}/children?page_size=100" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Notion-Version: 2022-06-28")

          UPDATED_COUNT=0

          # 1. paragraph Î∏îÎ°ùÏóêÏÑú "‚è≥ Phase N:" Ï∞æÏïÑÏÑú "‚úÖ Phase N:"ÏúºÎ°ú Î≥ÄÍ≤Ω
          echo "üîÑ Searching for paragraph blocks with ‚è≥ Phase ${PHASE_NUM}..."
          PARAGRAPH_BLOCKS=$(echo "$BLOCKS_RESPONSE" | jq -r --arg phase "Phase ${PHASE_NUM}" '.results[] | select(.type == "paragraph") | select(.paragraph.rich_text[0].text.content | contains($phase)) | .id')

          for BLOCK_ID in $PARAGRAPH_BLOCKS; do
            BLOCK_TEXT=$(echo "$BLOCKS_RESPONSE" | jq -r --arg id "$BLOCK_ID" '.results[] | select(.id == $id) | .paragraph.rich_text[0].text.content')

            # ‚è≥Í∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÏóÖÎç∞Ïù¥Ìä∏
            if echo "$BLOCK_TEXT" | grep -q "‚è≥ Phase ${PHASE_NUM}"; then
              NEW_TEXT=$(echo "$BLOCK_TEXT" | sed "s/‚è≥ Phase ${PHASE_NUM}/‚úÖ Phase ${PHASE_NUM}/g")
              echo "Updating paragraph: $BLOCK_TEXT -> $NEW_TEXT"

              UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "https://api.notion.com/v1/blocks/${BLOCK_ID}" \
                -H "Authorization: Bearer ${NOTION_API_KEY}" \
                -H "Content-Type: application/json" \
                -H "Notion-Version: 2022-06-28" \
                -d '{
                  "paragraph": {
                    "rich_text": [
                      {
                        "type": "text",
                        "text": {
                          "content": "'"${NEW_TEXT}"'"
                        }
                      }
                    ]
                  }
                }')

              UPDATE_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
              if [ "$UPDATE_CODE" = "200" ]; then
                UPDATED_COUNT=$((UPDATED_COUNT + 1))
                echo "‚úÖ Paragraph updated successfully"
              else
                echo "‚ö†Ô∏è Failed to update paragraph (HTTP $UPDATE_CODE)"
              fi
              sleep 0.3
            fi
          done

          # 2. to_do Î∏îÎ°ùÏóêÏÑú "Phase N:" Ï∞æÏïÑÏÑú checked: trueÎ°ú Î≥ÄÍ≤Ω
          echo "üîÑ Searching for to_do blocks with Phase ${PHASE_NUM}..."
          TODO_BLOCKS=$(echo "$BLOCKS_RESPONSE" | jq -r --arg phase "Phase ${PHASE_NUM}" '.results[] | select(.type == "to_do") | select(.to_do.rich_text[0].text.content | contains($phase)) | select(.to_do.checked == false) | .id')

          for BLOCK_ID in $TODO_BLOCKS; do
            BLOCK_TEXT=$(echo "$BLOCKS_RESPONSE" | jq -r --arg id "$BLOCK_ID" '.results[] | select(.id == $id) | .to_do.rich_text[0].text.content')
            echo "Checking to_do: $BLOCK_TEXT"

            UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "https://api.notion.com/v1/blocks/${BLOCK_ID}" \
              -H "Authorization: Bearer ${NOTION_API_KEY}" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d '{
                "to_do": {
                  "checked": true
                }
              }')

            UPDATE_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
            if [ "$UPDATE_CODE" = "200" ]; then
              UPDATED_COUNT=$((UPDATED_COUNT + 1))
              echo "‚úÖ To-do checked successfully"
            else
              echo "‚ö†Ô∏è Failed to update to_do (HTTP $UPDATE_CODE)"
            fi
            sleep 0.3
          done

          # 3. has_children=trueÏù∏ Î∏îÎ°ùÏùò ÏûêÏãùÏóêÏÑú bulleted_list_item Í≤ÄÏÉâ
          echo "üîÑ Searching for nested bulleted_list_item blocks..."
          PARENT_BLOCKS=$(echo "$BLOCKS_RESPONSE" | jq -r '.results[] | select(.has_children == true) | .id')

          for PARENT_ID in $PARENT_BLOCKS; do
            CHILDREN_RESPONSE=$(curl -s -X GET "https://api.notion.com/v1/blocks/${PARENT_ID}/children?page_size=100" \
              -H "Authorization: Bearer ${NOTION_API_KEY}" \
              -H "Notion-Version: 2022-06-28")

            # bulleted_list_itemÏóêÏÑú Phase Í≤ÄÏÉâ
            BULLET_BLOCKS=$(echo "$CHILDREN_RESPONSE" | jq -r --arg phase "Phase ${PHASE_NUM}" \
              '.results[] | select(.type == "bulleted_list_item") | select(.bulleted_list_item.rich_text[0].text.content | contains($phase)) | .id' 2>/dev/null)

            for BLOCK_ID in $BULLET_BLOCKS; do
              BLOCK_TEXT=$(echo "$CHILDREN_RESPONSE" | jq -r --arg id "$BLOCK_ID" \
                '.results[] | select(.id == $id) | .bulleted_list_item.rich_text[0].text.content')

              if echo "$BLOCK_TEXT" | grep -q "‚è≥ Phase ${PHASE_NUM}"; then
                NEW_TEXT=$(echo "$BLOCK_TEXT" | sed "s/‚è≥ Phase ${PHASE_NUM}/‚úÖ Phase ${PHASE_NUM}/g")
                echo "Updating bulleted_list_item: $BLOCK_TEXT -> $NEW_TEXT"

                UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "https://api.notion.com/v1/blocks/${BLOCK_ID}" \
                  -H "Authorization: Bearer ${NOTION_API_KEY}" \
                  -H "Content-Type: application/json" \
                  -H "Notion-Version: 2022-06-28" \
                  -d '{
                    "bulleted_list_item": {
                      "rich_text": [{"type": "text", "text": {"content": "'"${NEW_TEXT}"'"}}]
                    }
                  }')

                UPDATE_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
                if [ "$UPDATE_CODE" = "200" ]; then
                  UPDATED_COUNT=$((UPDATED_COUNT + 1))
                  echo "‚úÖ Bulleted list item updated successfully"
                else
                  echo "‚ö†Ô∏è Failed to update bulleted_list_item (HTTP $UPDATE_CODE)"
                fi
                sleep 0.3
              fi
            done

            # ÏûêÏãù Î∏îÎ°ùÏùò to_doÎèÑ Í≤ÄÏÉâ
            CHILD_TODO_BLOCKS=$(echo "$CHILDREN_RESPONSE" | jq -r --arg phase "Phase ${PHASE_NUM}" \
              '.results[] | select(.type == "to_do") | select(.to_do.rich_text[0].text.content | contains($phase)) | select(.to_do.checked == false) | .id' 2>/dev/null)

            for BLOCK_ID in $CHILD_TODO_BLOCKS; do
              BLOCK_TEXT=$(echo "$CHILDREN_RESPONSE" | jq -r --arg id "$BLOCK_ID" \
                '.results[] | select(.id == $id) | .to_do.rich_text[0].text.content')
              echo "Checking nested to_do: $BLOCK_TEXT"

              UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "https://api.notion.com/v1/blocks/${BLOCK_ID}" \
                -H "Authorization: Bearer ${NOTION_API_KEY}" \
                -H "Content-Type: application/json" \
                -H "Notion-Version: 2022-06-28" \
                -d '{
                  "to_do": {
                    "checked": true
                  }
                }')

              UPDATE_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
              if [ "$UPDATE_CODE" = "200" ]; then
                UPDATED_COUNT=$((UPDATED_COUNT + 1))
                echo "‚úÖ Nested to-do checked successfully"
              else
                echo "‚ö†Ô∏è Failed to update nested to_do (HTTP $UPDATE_CODE)"
              fi
              sleep 0.3
            done

            sleep 0.3
          done

          echo "üìä Updated $UPDATED_COUNT block(s) for Phase $PHASE_NUM"
          echo "phase_updated=true" >> $GITHUB_OUTPUT
          echo "phase_number=$PHASE_NUM" >> $GITHUB_OUTPUT

      - name: Update Codebase State in Context Hub
        id: codebase_state
        continue-on-error: true
        if: steps.task.outputs.task_number != 'none'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          CONTEXT_HUB_PAGE_ID: ${{ secrets.CONTEXT_HUB_PAGE_ID }}
          COMMIT_MESSAGE: ${{ steps.task.outputs.commit_message }}
          COMMIT_TIME: ${{ steps.commit.outputs.time }}
        run: |
          echo "üìä Updating Codebase State (bulleted_list_item)..."

          # ÌòÑÏû¨ ÎÇ†Ïßú (Î∞∞Ìè¨Ïùº)
          DEPLOY_DATE=$(echo "$COMMIT_TIME" | cut -d' ' -f1)
          echo "Deploy date: $DEPLOY_DATE"

          # Ïª§Î∞ã Î©îÏãúÏßÄÏóêÏÑú ÌäπÏàòÎ¨∏Ïûê Ïù¥Ïä§ÏºÄÏù¥ÌîÑ
          ESCAPED_MSG=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | head -c 100)
          echo "Commit message: $ESCAPED_MSG"

          # ÌéòÏù¥ÏßÄ Î∏îÎ°ùÎì§ Ï°∞Ìöå
          BLOCKS_RESPONSE=$(curl -s -X GET "https://api.notion.com/v1/blocks/${CONTEXT_HUB_PAGE_ID}/children?page_size=100" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Notion-Version: 2022-06-28")

          UPDATED_COUNT=0

          # bulleted_list_itemÏóêÏÑú "ÎßàÏßÄÎßâ Ïª§Î∞ã:" Ï∞æÍ∏∞
          COMMIT_BLOCK_ID=$(echo "$BLOCKS_RESPONSE" | jq -r '.results[] | select(.type == "bulleted_list_item") | select(.bulleted_list_item.rich_text[0].text.content | startswith("ÎßàÏßÄÎßâ Ïª§Î∞ã:")) | .id' | head -1)
          if [ -n "$COMMIT_BLOCK_ID" ] && [ "$COMMIT_BLOCK_ID" != "null" ]; then
            echo "Found ÎßàÏßÄÎßâ Ïª§Î∞ã block: $COMMIT_BLOCK_ID"
            NEW_COMMIT_TEXT="ÎßàÏßÄÎßâ Ïª§Î∞ã: ${ESCAPED_MSG}"

            curl -s -X PATCH "https://api.notion.com/v1/blocks/${COMMIT_BLOCK_ID}" \
              -H "Authorization: Bearer ${NOTION_API_KEY}" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d '{
                "bulleted_list_item": {
                  "rich_text": [{"type": "text", "text": {"content": "'"${NEW_COMMIT_TEXT}"'"}}]
                }
              }' > /dev/null
            echo "‚úÖ 'ÎßàÏßÄÎßâ Ïª§Î∞ã' updated"
            UPDATED_COUNT=$((UPDATED_COUNT + 1))
            sleep 0.3
          else
            echo "‚ö†Ô∏è 'ÎßàÏßÄÎßâ Ïª§Î∞ã' block not found"
          fi

          # bulleted_list_itemÏóêÏÑú "ÎßàÏßÄÎßâ Î∞∞Ìè¨:" Ï∞æÍ∏∞
          DEPLOY_BLOCK_ID=$(echo "$BLOCKS_RESPONSE" | jq -r '.results[] | select(.type == "bulleted_list_item") | select(.bulleted_list_item.rich_text[0].text.content | startswith("ÎßàÏßÄÎßâ Î∞∞Ìè¨:")) | .id' | head -1)
          if [ -n "$DEPLOY_BLOCK_ID" ] && [ "$DEPLOY_BLOCK_ID" != "null" ]; then
            echo "Found ÎßàÏßÄÎßâ Î∞∞Ìè¨ block: $DEPLOY_BLOCK_ID"
            NEW_DEPLOY_TEXT="ÎßàÏßÄÎßâ Î∞∞Ìè¨: ${DEPLOY_DATE}"

            curl -s -X PATCH "https://api.notion.com/v1/blocks/${DEPLOY_BLOCK_ID}" \
              -H "Authorization: Bearer ${NOTION_API_KEY}" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d '{
                "bulleted_list_item": {
                  "rich_text": [{"type": "text", "text": {"content": "'"${NEW_DEPLOY_TEXT}"'"}}]
                }
              }' > /dev/null
            echo "‚úÖ 'ÎßàÏßÄÎßâ Î∞∞Ìè¨' updated"
            UPDATED_COUNT=$((UPDATED_COUNT + 1))
          else
            echo "‚ö†Ô∏è 'ÎßàÏßÄÎßâ Î∞∞Ìè¨' block not found"
          fi

          echo "üìä Codebase State update complete ($UPDATED_COUNT blocks updated)"

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOYMENT_URL: ${{ github.event.deployment_status.target_url }}
          TASK_NUMBER: ${{ steps.task.outputs.task_number }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
          COMMIT_TIME: ${{ steps.commit.outputs.time }}
          COMMIT_MESSAGE: ${{ steps.task.outputs.commit_message }}
          CONTEXT_HUB_UPDATED: ${{ steps.notion.outputs.updated }}
        run: |
          echo "Debug: TASK_NUMBER before Slack notification is '$TASK_NUMBER'"
          if [ -n "$TASK_NUMBER" ] && [ "$TASK_NUMBER" != "none" ]; then
            TASK_TITLE="Task ${TASK_NUMBER}"
          else
            TASK_TITLE="Î∞∞Ìè¨"
          fi

          # Context Hub ÏóÖÎç∞Ïù¥Ìä∏ ÏÉÅÌÉú Î©îÏãúÏßÄ
          if [ "$CONTEXT_HUB_UPDATED" = "true" ]; then
            CONTEXT_HUB_STATUS="üîó Context Hub ÏóÖÎç∞Ïù¥Ìä∏Îê®"
          elif [ "$TASK_NUMBER" = "none" ]; then
            CONTEXT_HUB_STATUS="‚ÑπÔ∏è Task ÏóÜÏùå - Context Hub Ïä§ÌÇµ"
          else
            CONTEXT_HUB_STATUS="‚ö†Ô∏è Context Hub ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "üöÄ Î∞∞Ìè¨ ÏôÑÎ£å: '"${TASK_TITLE}"'",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Î∞∞Ìè¨ ÏôÑÎ£å: '"${TASK_TITLE}"'",
                    "emoji": true
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üì¶ *Ïª§Î∞ã*\n`'"${COMMIT_SHA}"'`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "‚è∞ *ÏãúÍ∞Å*\n'"${COMMIT_TIME}"'"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üåê *URL*\n<'"${DEPLOYMENT_URL}"'|Î∞∞Ìè¨ ÌôïÏù∏>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "üí¨ *Î©îÏãúÏßÄ*\n'"${COMMIT_MESSAGE}"'"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "'"${CONTEXT_HUB_STATUS}"'"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "‚úÖ Task ÏôÑÎ£å Ïãú üëç Î•º ÎàåÎü¨Ï£ºÏÑ∏Ïöî"
                    }
                  ]
                }
              ]
            }'

  backup-to-drive:
    runs-on: ubuntu-latest
    needs: notify-deployment
    if: always() && (github.event_name == 'workflow_dispatch' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Notion to Google Drive Sync
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_API_KEY }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: "1kYWkO4shselSCG-nmR8t4Wx6c-7l22So"
          NOTION_PAGE_ID: ${{ secrets.CONTEXT_HUB_PAGE_ID }}
        run: python sync_notion_to_drive.py