name: Slack Approval Notification

on:
  push:
    branches: [main]
    paths:
      - 'triggers/pending-approval/**'

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Get pending approval files
        id: get_files
        run: |
          FILES=$(ls triggers/pending-approval/*.json 2>/dev/null || echo "")
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Send Slack notification
        if: steps.get_files.outputs.files != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          for file in triggers/pending-approval/*.json; do
            if [ -f "$file" ]; then
              TASK_ID=$(basename "$file" .json)
              CONTENT=$(cat "$file")
              
              TITLE=$(echo "$CONTENT" | jq -r '.title // "Unknown Task"')
              COMPLEXITY=$(echo "$CONTENT" | jq -r '.complexity // 5')
              ESTIMATED_TIME=$(echo "$CONTENT" | jq -r '.estimated_time // "Unknown"')
              EXECUTOR=$(echo "$CONTENT" | jq -r '.recommended_executor // "gemini_cli"')
              QUOTA_ESTIMATE=$(echo "$CONTENT" | jq -r '.quota_estimate // 100')
              
              curl -X POST "$SLACK_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d "{
                  \"text\": \"ü§ù AI ÌòëÏùò ÏôÑÎ£å - $TASK_ID\",
                  \"blocks\": [
                    {
                      \"type\": \"header\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"‚úÖ $TITLE\",
                        \"emoji\": true
                      }
                    },
                    {
                      \"type\": \"section\",
                      \"fields\": [
                        {\"type\": \"mrkdwn\", \"text\": \"*Task ID:*\n$TASK_ID\"},
                        {\"type\": \"mrkdwn\", \"text\": \"*Î≥µÏû°ÎèÑ:*\n$COMPLEXITY/10\"},
                        {\"type\": \"mrkdwn\", \"text\": \"*ÏòàÏÉÅ ÏãúÍ∞Ñ:*\n$ESTIMATED_TIME\"},
                        {\"type\": \"mrkdwn\", \"text\": \"*ÏòàÏÉÅ ÏöîÏ≤≠:*\n~$QUOTA_ESTIMATEÌöå\"}
                      ]
                    },
                    {\"type\": \"divider\"},
                    {
                      \"type\": \"section\",
                      \"text\": {\"type\": \"mrkdwn\", \"text\": \"*Í∂åÏû• Ïã§ÌñâÏûê:* $EXECUTOR\"}
                    },
                    {
                      \"type\": \"actions\",
                      \"elements\": [
                        {
                          \"type\": \"button\",
                          \"text\": {\"type\": \"plain_text\", \"text\": \"‚úÖ Gemini CLIÎ°ú Ïã§Ìñâ\", \"emoji\": true},
                          \"style\": \"primary\",
                          \"value\": \"$TASK_ID|gemini_cli\",
                          \"action_id\": \"approve_gemini\"
                        },
                        {
                          \"type\": \"button\",
                          \"text\": {\"type\": \"plain_text\", \"text\": \"ü§ñ Claude CodeÎ°ú Ïã§Ìñâ\", \"emoji\": true},
                          \"value\": \"$TASK_ID|claude_code\",
                          \"action_id\": \"approve_claude_code\"
                        },
                        {
                          \"type\": \"button\",
                          \"text\": {\"type\": \"plain_text\", \"text\": \"‚ùå Í±∞Î∂Ä\", \"emoji\": true},
                          \"style\": \"danger\",
                          \"value\": \"$TASK_ID|reject\",
                          \"action_id\": \"reject\"
                        }
                      ]
                    }
                  ]
                }"
            fi
          done