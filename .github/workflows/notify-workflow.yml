name: JAMUS Workflow Notifications

on:
  push:
    paths:
      - 'DEV_MEMO.md'

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check workflow stage
        id: check
        run: |
          # Claude 판단 섹션 존재 확인
          HAS_CLAUDE=$(grep -c "Claude 최종 판단" DEV_MEMO.md || true)
          
          # 승인 상태 확인 (간단하게)
          HAS_APPROVAL=$(grep -c "상태: 승인" DEV_MEMO.md || true)
          
          # 반려 상태 확인
          HAS_REJECTION=$(grep -c "상태: 반려" DEV_MEMO.md || true)
          
          # 성민님 결정 확인
          HAS_DECISION=$(grep -c "성민님 최종 결정" DEV_MEMO.md || true)
          
          # Gemini 검토 확인
          HAS_GEMINI=$(grep -c "종합 의견:" DEV_MEMO.md || true)
          
          echo "Debug: HAS_CLAUDE=$HAS_CLAUDE HAS_APPROVAL=$HAS_APPROVAL HAS_DECISION=$HAS_DECISION HAS_GEMINI=$HAS_GEMINI"
          
          if [ "$HAS_GEMINI" -gt 0 ] && [ "$HAS_CLAUDE" -eq 0 ]; then
            echo "stage=gemini_done" >> $GITHUB_OUTPUT
          elif [ "$HAS_CLAUDE" -gt 0 ] && [ "$HAS_APPROVAL" -gt 0 ] && [ "$HAS_DECISION" -eq 0 ]; then
            echo "stage=approval_needed" >> $GITHUB_OUTPUT
          elif [ "$HAS_CLAUDE" -gt 0 ] && [ "$HAS_REJECTION" -gt 0 ]; then
            echo "stage=rejected" >> $GITHUB_OUTPUT
          fi

      - name: Slack - Gemini Done
        if: steps.check.outputs.stage == 'gemini_done'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{"text": "🟡 Gemini 검토 완료!\n\nClaude에게 \"Gemini 검토 완료\" 입력해주세요."}'

      - name: Slack - Approval Needed
        if: steps.check.outputs.stage == 'approval_needed'
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{"text": "✅ Claude ↔ Gemini 합의 완료!\n\n최종 구현 승인이 필요합니다.\n\nhttps://github.com/Christofer566/JAMUS/blob/main/DEV_MEMO.md"}'

      - name: Auto - Create Re-review Trigger
        if: steps.check.outputs.stage == 'rejected'
        run: |
          echo '{"action": "rereview", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > triggers/gemini-rereview.json
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add triggers/gemini-rereview.json
          git commit -m "🔄 Trigger Gemini re-review"
          git push
